---
title: "Map Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
source_code: embed
---
```{r set up, include=FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
library(patchwork)
library(knitr)
library(MASS)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  digits = 3
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d 
knitr::opts_chunk$set(
  fig.height = 6,
  fig.width = 8,
  message = F,
  warning = F 
  )
```

```{r load and clean dataset, include=FALSE}
summary_household_category <- read_csv("./data/summary_household_category.csv")

shiny_state_map_df = summary_household_category %>% 
  group_by(state,year, category) %>%
  mutate(
     category = replace(category, category == "caring_duties", "caring duties"),
     category = replace(category, category == "eating_drinking", "eating/drinking"),
     category = replace(category, category == "gov_civic_obligations", "gov/civic obligations"),
     category = replace(category, category == "personal_care", "personal care"),
     category = replace(category, category == "professional_services", "professional services"),
     category = replace(category, category == "religious_spiritual", "religious/spiritual")) %>%
  summarise(avg_time = sum(category_sum_hour*weight)/sum(weight))
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r selectors, message = FALSE, echo= FALSE, warning = FALSE}
year_choice = unique(shiny_state_map_df$year)

radioButtons(
  "year_choice",
  label = h4("Year"),
  choices = year_choice,
  selected = "2020"
)

category_choice = 
  shiny_state_map_df %>%
  distinct(category) %>%
  pull()
  
selectInput(
  "category_choice",
  label = h4("Select Category"),
  choices = category_choice,
  selected = "Leisure"
)
```

Column {data-width=650}
-----------------------------------------------------------------------

### U.S. Map

```{r map, message = FALSE, echo= FALSE, warning = FALSE}
renderPlotly({
  
  df = read.csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv")

l <- list(color = toRGB("white"), width = 2)
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
  
plot_geo(shiny_state_map_df %>% 
            filter(
              year == input[["year_choice"]],
              category == input[["category_choice"]]),
            locationmode = 'USA-states') %>% 
       add_trace(
              z = ~avg_time, locations = ~state, text = "hours",
      color = ~avg_time, colors = 'Purples'
                ) %>% 
  colorbar(title = "hours each day") %>% 
  layout(
    title = paste('Average time spent in a day on each activity by state', input[["year_choice"]]),
    geo = g
  )
})
```


Column {data-width=350}
-----------------------------------------------------------------------

### Year

```{r year, message = FALSE, echo= FALSE, warning = FALSE}
renderPrint({
  input[["year_choice"]]
})
```

### Activity Category

```{r category, message = FALSE, echo= FALSE, warning = FALSE}
renderPrint({
  input[["category_choice"]]
})
```

